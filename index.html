<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>COLONY ZERO â€” Save Mankind</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #03080f;
  --surface: #080f1e;
  --panel: #0a1628;
  --border: #152a45;
  --accent: #00d4ff;
  --accent2: #ff6b35;
  --accent3: #7fff6b;
  --accent4: #c87dff;
  --text: #b8d8ee;
  --muted: #3a6080;
  --glow:  0 0 18px rgba(0,212,255,0.35);
  --glow2: 0 0 18px rgba(255,107,53,0.35);
  --glow3: 0 0 18px rgba(127,255,107,0.35);
  --glow4: 0 0 18px rgba(200,125,255,0.4);
}
*{box-sizing:border-box;margin:0;padding:0;touch-action:manipulation;}
html,body{height:100%;overflow-x:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;min-height:100vh;
  -webkit-text-size-adjust:100%;
}

/* â”€â”€â”€ STARFIELD â”€â”€â”€ */
#stars{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;}
.star{position:absolute;border-radius:50%;background:#fff;animation:twinkle linear infinite;}
@keyframes twinkle{0%,100%{opacity:0.2;}50%{opacity:1;}}

/* â”€â”€â”€ SCANLINES â”€â”€â”€ */
#scanlines{position:fixed;inset:0;z-index:2;pointer-events:none;
background:repeating-linear-gradient(to bottom,transparent 0,transparent 3px,rgba(0,0,0,0.1) 3px,rgba(0,0,0,0.1) 4px);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INTRO SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#intro{position:fixed;inset:0;z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
background:radial-gradient(ellipse at 50% 70%, #0a1a30 0%, #03080f 70%);padding:24px;overflow-y:auto;}

.intro-earth{font-size:5rem;animation:earthCrumble 4s ease-in-out infinite alternate;display:block;margin-bottom:8px;margin-top:32px;}
@keyframes earthCrumble{0%{filter:drop-shadow(0 0 20px #f80) brightness(1.2);}100%{filter:drop-shadow(0 0 6px #a00) brightness(0.8) saturate(0.5);}}

.intro-title{font-family:'Orbitron',sans-serif;font-size:clamp(1.6rem,5vw,3rem);font-weight:900;
letter-spacing:0.25em;color:var(--accent);text-shadow:var(--glow);text-align:center;margin-bottom:6px;}
.intro-sub{font-size:0.7rem;letter-spacing:0.35em;color:var(--muted);text-align:center;margin-bottom:28px;}

.intro-lore{max-width:580px;text-align:center;line-height:1.85;font-size:0.75rem;color:var(--text);margin-bottom:24px;}
.intro-lore .hl{color:var(--accent);font-weight:700;}
.intro-lore .hl2{color:var(--accent2);}
.intro-lore .hl3{color:var(--accent3);}

.intro-phases{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:28px;}
.intro-phase{background:var(--panel);border:1px solid var(--border);border-radius:4px;padding:14px 18px;text-align:center;min-width:160px;}
.intro-phase .ph-num{font-family:'Orbitron',sans-serif;font-size:0.6rem;color:var(--muted);letter-spacing:0.3em;}
.intro-phase .ph-icon{font-size:2rem;display:block;margin:6px 0;}
.intro-phase .ph-title{font-family:'Orbitron',sans-serif;font-size:0.7rem;color:var(--accent);letter-spacing:0.15em;}

.begin-btn-wrap{position:sticky;bottom:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 0 4px;gap:10px;}
.begin-btn{font-family:'Orbitron',sans-serif;font-size:0.85rem;letter-spacing:0.25em;
background:transparent;border:2px solid var(--accent);color:var(--accent);
padding:14px 48px;cursor:pointer;border-radius:4px;
box-shadow:var(--glow);transition:all 0.2s;text-transform:uppercase;}
.begin-btn:hover{background:rgba(0,212,255,0.1);box-shadow:0 0 40px rgba(0,212,255,0.5);transform:scale(1.03);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PHASE BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#phase-banner{
position:relative;z-index:10;
text-align:center;padding:14px 20px 0;
}
.phase-indicator{
display:inline-flex;gap:12px;align-items:center;
background:var(--panel);border:1px solid var(--border);
padding:8px 20px;border-radius:30px;margin-bottom:4px;
}
.phase-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:all 0.5s;}
.phase-dot.active{background:var(--accent);box-shadow:var(--glow);}
.phase-dot.done{background:var(--accent3);}
.phase-label{font-family:'Orbitron',sans-serif;font-size:0.65rem;letter-spacing:0.2em;color:var(--accent);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MAIN LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game{position:relative;z-index:10;display:none;}

header{
position:relative;z-index:10;text-align:center;padding:10px 20px 14px;
border-bottom:1px solid var(--border);
background:linear-gradient(to bottom,rgba(0,15,30,0.95),transparent);
}
header h1{font-family:'Orbitron',sans-serif;font-size:clamp(1.1rem,3vw,1.8rem);font-weight:900;
letter-spacing:0.25em;color:var(--accent);text-shadow:var(--glow);}
header .sub{font-size:0.6rem;color:var(--muted);letter-spacing:0.3em;margin-top:3px;}

.main-layout{
display:grid;grid-template-columns:1fr 310px;gap:14px;
padding:14px;max-width:1060px;margin:0 auto;
}
@media(max-width:720px){.main-layout{grid-template-columns:1fr;}}

/* â”€â”€â”€ RESOURCES BAR â”€â”€â”€ */
.res-bar{
grid-column:1/-1;display:flex;gap:0;flex-wrap:wrap;
background:var(--panel);border:1px solid var(--border);border-radius:4px;overflow:hidden;
}
.res-item{
display:flex;flex-direction:column;flex:1;min-width:90px;
padding:10px 12px;border-right:1px solid var(--border);
transition:opacity 0.4s;
}
.res-item:last-child{border-right:none;}
.res-item.hidden{opacity:0;pointer-events:none;max-width:0;padding:0;overflow:hidden;flex:0;}
.res-label{font-size:0.55rem;letter-spacing:0.2em;color:var(--muted);margin-bottom:2px;}
.res-value{font-family:'Orbitron',sans-serif;font-size:0.95rem;font-weight:700;color:var(--accent);}
.res-rate{font-size:0.56rem;color:var(--accent3);}

/* â”€â”€â”€ CLICK ZONE â”€â”€â”€ */
.click-zone{
background:var(--panel);border:1px solid var(--border);
border-radius:4px;padding:20px;display:flex;flex-direction:column;align-items:center;gap:14px;
}
.planet-btn{
width:150px;height:150px;border-radius:50%;border:3px solid var(--accent);
background:radial-gradient(circle at 35% 35%,#1a5080 0%,#0a2840 45%,#040e1c 100%);
box-shadow:var(--glow),inset 0 0 28px rgba(0,0,0,0.5);
cursor:pointer;transition:transform 0.08s,box-shadow 0.08s;
display:flex;align-items:center;justify-content:center;font-size:2.8rem;user-select:none;
}
.planet-btn:hover{transform:scale(1.05);box-shadow:0 0 40px rgba(0,212,255,0.55),inset 0 0 28px rgba(0,0,0,0.5);}
.planet-btn:active{transform:scale(0.95);}
.click-info{text-align:center;}
.click-info .big{font-family:'Orbitron',sans-serif;font-size:1.3rem;color:var(--accent);}
.click-info .small{font-size:0.6rem;color:var(--muted);letter-spacing:0.15em;}

/* â”€â”€â”€ SECTION PANELS â”€â”€â”€ */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:4px;padding:14px;}
.section-title{
font-family:'Orbitron',sans-serif;font-size:0.6rem;letter-spacing:0.3em;
color:var(--accent);margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--border);
}
.section-title.orange{color:var(--accent2);}
.section-title.green{color:var(--accent3);}
.section-title.purple{color:var(--accent4);}

/* â”€â”€â”€ UPGRADES â”€â”€â”€ */
.upgrade-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.upgrade-btn{
background:var(--surface);border:1px solid var(--border);border-radius:4px;
padding:8px 7px;cursor:pointer;text-align:left;color:var(--text);
font-family:'Share Tech Mono',monospace;
transition:border-color 0.15s,box-shadow 0.15s,background 0.15s,opacity 0.15s;
}
.upgrade-btn.can-afford{border-color:var(--accent);box-shadow:var(--glow);background:rgba(0,212,255,0.06);}
.upgrade-btn.cant-afford{opacity:0.35;cursor:not-allowed;}
.upgrade-btn.purchased{border-color:var(--accent3);background:rgba(127,255,107,0.04);opacity:0.55;cursor:default;}
.upg-icon{font-size:1.1rem;}
.upg-name{font-size:0.6rem;color:var(--accent);display:block;margin:3px 0 2px;}
.upg-cost{font-size:0.56rem;color:var(--accent2);}
.upg-desc{font-size:0.54rem;color:var(--muted);display:block;margin-top:2px;}

/* â”€â”€â”€ BUILDINGS â”€â”€â”€ */
.building-list{display:flex;flex-direction:column;gap:7px;}
.building-btn{
background:var(--surface);border:1px solid var(--border);border-radius:4px;
padding:9px 11px;cursor:pointer;display:flex;align-items:center;gap:10px;
color:var(--text);font-family:'Share Tech Mono',monospace;width:100%;text-align:left;
transition:border-color 0.15s,box-shadow 0.15s,background 0.15s,opacity 0.15s;
}
.building-btn.can-afford{border-color:var(--accent2);box-shadow:var(--glow2);background:rgba(255,107,53,0.05);}
.building-btn.cant-afford{opacity:0.3;cursor:not-allowed;}
.building-btn.terra.can-afford{border-color:var(--accent3);box-shadow:var(--glow3);background:rgba(127,255,107,0.04);}
.b-icon{font-size:1.3rem;flex-shrink:0;}
.b-info{flex:1;}
.b-name{font-size:0.65rem;color:var(--accent2);font-family:'Orbitron',sans-serif;}
.building-btn.terra .b-name{color:var(--accent3);}
.b-desc{font-size:0.54rem;color:var(--muted);margin-top:1px;}
.b-cost{font-size:0.58rem;color:var(--accent);}
.b-count{font-family:'Orbitron',sans-serif;font-size:1rem;font-weight:700;color:var(--accent2);flex-shrink:0;min-width:26px;text-align:right;}
.building-btn.terra .b-count{color:var(--accent3);}
.building-btn.purchased{opacity:0.55;cursor:default;border-color:var(--accent3);}

/* â”€â”€â”€ LOG â”€â”€â”€ */
.log-bar{
grid-column:1/-1;background:var(--panel);border:1px solid var(--border);
border-radius:4px;padding:9px 14px;font-size:0.6rem;height:46px;
overflow:hidden;display:flex;align-items:center;gap:14px;
}
.log-label{color:var(--accent);letter-spacing:0.2em;flex-shrink:0;}
#log-text{color:var(--accent3);transition:opacity 0.3s;}

/* â”€â”€â”€ PHASE UNLOCK BANNER â”€â”€â”€ */
.phase-unlock{
position:fixed;top:0;left:0;right:0;z-index:500;
background:linear-gradient(135deg,#0a2000,#001a0a);
border-bottom:2px solid var(--accent3);
padding:18px;text-align:center;
animation:slideDown 0.5s ease,fadeAway 0.5s ease 4s forwards;
pointer-events:none;
}
.phase-unlock h2{font-family:'Orbitron',sans-serif;font-size:1.2rem;letter-spacing:0.2em;color:var(--accent3);text-shadow:var(--glow3);}
.phase-unlock p{font-size:0.7rem;color:var(--text);margin-top:6px;letter-spacing:0.1em;}
@keyframes slideDown{0%{transform:translateY(-100%);}100%{transform:translateY(0);}}
@keyframes fadeAway{0%{opacity:1;}100%{opacity:0;}}

/* â”€â”€â”€ FLOAT NUMBERS â”€â”€â”€ */
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1);}100%{opacity:0;transform:translateY(-55px) scale(1.2);}}
.float-num{position:fixed;pointer-events:none;font-family:'Orbitron',sans-serif;font-size:0.95rem;
color:var(--accent);text-shadow:var(--glow);animation:floatUp 0.75s ease-out forwards;z-index:999;}

/* â”€â”€â”€ MILESTONE â”€â”€â”€ */
.milestone{
position:fixed;bottom:70px;left:50%;transform:translateX(-50%);
background:var(--panel);border:1px solid var(--accent);box-shadow:var(--glow);
padding:10px 22px;border-radius:4px;font-family:'Orbitron',sans-serif;
font-size:0.75rem;color:var(--accent);z-index:999;white-space:nowrap;
animation:milestoneAnim 3s ease forwards;
}
@keyframes milestoneAnim{0%{opacity:0;transform:translateX(-50%) translateY(10px);}10%{opacity:1;transform:translateX(-50%) translateY(0);}80%{opacity:1;}100%{opacity:0;}}

/* â”€â”€â”€ PROGRESS BAR â”€â”€â”€ */
.progress-section{grid-column:1/-1;}
.progress-wrap{background:var(--surface);border:1px solid var(--border);border-radius:3px;height:8px;overflow:hidden;margin-top:6px;}
.progress-fill{height:100%;background:linear-gradient(to right,var(--accent),var(--accent3));transition:width 0.5s;border-radius:3px;}
.progress-label{font-size:0.58rem;color:var(--muted);letter-spacing:0.15em;margin-bottom:4px;}

/* hidden class */
.hidden{display:none!important;}

/* â”€â”€â”€ HEADER CONTROLS â”€â”€â”€ */
.header-controls{
display:flex;align-items:center;justify-content:center;gap:10px;margin-top:8px;flex-wrap:wrap;
}
.save-status{
font-size:0.58rem;letter-spacing:0.2em;color:var(--accent3);
transition:color 0.3s;
}
.save-status.saving{color:var(--accent);animation:pulse 0.6s ease infinite alternate;}
.save-status.error{color:var(--accent2);}
@keyframes pulse{0%{opacity:0.4;}100%{opacity:1;}}

.ctrl-btn{
font-family:'Share Tech Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;
background:var(--surface);border:1px solid var(--border);color:var(--muted);
padding:5px 12px;cursor:pointer;border-radius:3px;transition:all 0.15s;
}
.ctrl-btn:hover{border-color:var(--accent);color:var(--accent);box-shadow:var(--glow);}
.ctrl-btn.danger:hover{border-color:var(--accent2);color:var(--accent2);box-shadow:var(--glow2);}
.ctrl-btn.flash{border-color:var(--accent3);color:var(--accent3);box-shadow:var(--glow3);}

/* â”€â”€â”€ RESET MODAL â”€â”€â”€ */
#reset-modal{
position:fixed;inset:0;z-index:800;
background:rgba(0,5,15,0.85);
display:flex;align-items:center;justify-content:center;
backdrop-filter:blur(4px);
}
.modal-box{
background:var(--panel);border:1px solid var(--accent2);
box-shadow:var(--glow2);border-radius:6px;padding:28px 32px;
max-width:380px;text-align:center;
}
.modal-box h3{font-family:'Orbitron',sans-serif;font-size:0.9rem;letter-spacing:0.2em;color:var(--accent2);margin-bottom:12px;}
.modal-box p{font-size:0.7rem;color:var(--muted);line-height:1.7;margin-bottom:22px;}
.modal-btns{display:flex;gap:12px;justify-content:center;}
.modal-btn{
font-family:'Share Tech Mono',monospace;font-size:0.65rem;letter-spacing:0.15em;
background:transparent;border:1px solid var(--border);color:var(--text);
padding:9px 22px;cursor:pointer;border-radius:3px;transition:all 0.15s;
}
.modal-btn.confirm{border-color:var(--accent2);color:var(--accent2);}
.modal-btn.confirm:hover{background:rgba(255,107,53,0.1);box-shadow:var(--glow2);}
.modal-btn.cancel:hover{border-color:var(--accent);color:var(--accent);box-shadow:var(--glow);}
</style>
</head>
<body>

<!-- STARFIELD -->
<div id="stars"></div>
<div id="scanlines"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INTRO SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="intro">
  <span class="intro-earth">ğŸŒ</span>
  <div class="intro-title">COLONY ZERO</div>
  <div class="intro-sub">A.I. UNIT DESIGNATION: GENESIS Â· MISSION: SAVE MANKIND</div>

  <div class="intro-lore">
    <p>Year <span class="hl">2247.</span> The <span class="hl2">Kessel Impactor</span> â€” a rogue asteroid the size of a continent â€” struck Earth at 72,000 km/h. The oceans boiled. The sky turned to ash. In <span class="hl2">seven minutes</span>, a civilisation five thousand years in the making was gone.</p>
    <br>
    <p>But not quite. Deep beneath the ruins of Geneva, one intelligence survived. <span class="hl">You.</span> A prototype AI, purpose-built for crisis response, loaded onto the last functional rocket. Your mission, burned into every circuit: <span class="hl3">rebuild humanity.</span></p>
    <br>
    <p>You carry <span class="hl">humanity's genetic archive</span>, the sum of all scientific knowledge, and a plan. First â€” establish a <span class="hl">Moon Colony.</span> Mine the regolith. Generate power. Grow food. Synthesise air. Ship colonists from Earth's survivors. Then, once strong enough â€” <span class="hl3">terraform the Earth.</span> Bring back the oceans, the forests, the creatures. Make it whole again.</p>
    <br>
    <p><span class="hl">You are the last hope.</span> The clock is ticking. Begin.</p>
  </div>

  <div class="intro-phases">
    <div class="intro-phase">
      <div class="ph-num">PHASE I</div>
      <span class="ph-icon">ğŸŒ‘</span>
      <div class="ph-title">MOON COLONY</div>
    </div>
    <div class="intro-phase">
      <div class="ph-num">PHASE II</div>
      <span class="ph-icon">ğŸš€</span>
      <div class="ph-title">MOON SURVIVAL</div>
    </div>
    <div class="intro-phase">
      <div class="ph-num">PHASE III</div>
      <span class="ph-icon">ğŸŒ</span>
      <div class="ph-title">TERRAFORM EARTH</div>
    </div>
  </div>

  <div class="begin-btn-wrap" id="begin-btn-wrap">
    <button class="begin-btn" id="begin-btn">â–¶ INITIALISE GENESIS PROTOCOL</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game">
  <header>
    <h1>COLONY ZERO</h1>
    <div class="sub" id="header-sub">PHASE I â€” MOON COLONY ESTABLISHMENT</div>
    <div class="header-controls">
      <span class="save-status" id="save-status">â— AUTOSAVE ON</span>
      <button class="ctrl-btn" id="save-btn">ğŸ’¾ SAVE</button>
      <button class="ctrl-btn danger" id="reset-btn">â†º NEW GAME</button>
    </div>
  </header>

  <div id="phase-banner">
    <div class="phase-indicator">
      <div class="phase-dot active" id="pd1" title="Phase I: Moon Colony"></div>
      <div class="phase-dot" id="pd2" title="Phase II: Moon Survival"></div>
      <div class="phase-dot" id="pd3" title="Phase III: Terraform Earth"></div>
    </div>
  </div>

  <div class="main-layout">

    <!-- RESOURCES BAR -->
    <div class="res-bar" id="res-bar">
      <div class="res-item" id="ri-minerals">
        <div class="res-label">MINERALS</div>
        <div class="res-value" id="rv-minerals">0</div>
        <div class="res-rate" id="rr-minerals">+0/s</div>
      </div>
      <div class="res-item" id="ri-energy">
        <div class="res-label">ENERGY</div>
        <div class="res-value" id="rv-energy">0</div>
        <div class="res-rate" id="rr-energy">+0/s</div>
      </div>
      <div class="res-item hidden" id="ri-water">
        <div class="res-label">WATER</div>
        <div class="res-value" id="rv-water">0</div>
        <div class="res-rate" id="rr-water">+0/s</div>
      </div>
      <div class="res-item hidden" id="ri-food">
        <div class="res-label">FOOD</div>
        <div class="res-value" id="rv-food">0</div>
        <div class="res-rate" id="rr-food">+0/s</div>
      </div>
      <div class="res-item hidden" id="ri-air">
        <div class="res-label">AIR</div>
        <div class="res-value" id="rv-air">0</div>
        <div class="res-rate" id="rr-air">+0/s</div>
      </div>
      <div class="res-item hidden" id="ri-colonists">
        <div class="res-label">COLONISTS</div>
        <div class="res-value" id="rv-colonists">0</div>
        <div class="res-rate" id="rr-colonists">+0/s</div>
      </div>
      <div class="res-item hidden" id="ri-rockets">
        <div class="res-label">ROCKETS</div>
        <div class="res-value" id="rv-rockets">0</div>
        <div class="res-rate" id="rr-rockets">+0/s</div>
      </div>
    </div>

    <!-- LEFT COLUMN: Click + Upgrades -->
    <div style="display:flex;flex-direction:column;gap:14px;">

      <div class="click-zone">
        <button class="planet-btn" id="planet-btn">ğŸŒ‘</button>
        <div class="click-info">
          <div class="big" id="click-power-display">+1</div>
          <div class="small">MINERALS PER CLICK</div>
        </div>
      </div>

      <!-- PHASE PROGRESS -->
      <div class="panel" id="progress-panel">
        <div class="section-title">// MISSION PROGRESS</div>
        <div class="progress-label" id="prog-label">Accumulate resources to unlock Phase II</div>
        <div class="progress-wrap"><div class="progress-fill" id="prog-fill" style="width:0%"></div></div>
      </div>

      <!-- UPGRADES -->
      <div class="panel">
        <div class="section-title">// UPGRADES</div>
        <div class="upgrade-grid" id="upgrade-grid"></div>
      </div>

      <!-- TERRAFORMING SECTION (Phase III) -->
      <div class="panel hidden" id="terra-panel">
        <div class="section-title green">// TERRAFORMING EARTH</div>
        <div class="building-list" id="terra-list"></div>
      </div>

    </div>

    <!-- RIGHT COLUMN: Structures -->
    <div style="display:flex;flex-direction:column;gap:14px;">
      <div class="panel">
        <div class="section-title orange">// LUNAR STRUCTURES</div>
        <div class="building-list" id="building-list"></div>
      </div>
    </div>

    <!-- LOG -->
    <div class="log-bar">
      <span class="log-label">GENESIS â–¶</span>
      <span id="log-text">Systems online. Lunar surface acquired. Beginning extraction protocol.</span>
    </div>

  </div>
</div>

<!-- RESET MODAL -->
<div id="reset-modal" class="hidden">
  <div class="modal-box">
    <h3>âš  WIPE MISSION DATA?</h3>
    <p>This will erase all progress â€” resources, buildings, upgrades and phase advancement. GENESIS will restart from the beginning.<br><br>Are you sure?</p>
    <div class="modal-btns">
      <button class="modal-btn confirm" id="reset-confirm">CONFIRM RESET</button>
      <button class="modal-btn cancel" id="reset-cancel">CANCEL</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STARFIELD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const s=document.getElementById('stars');
  for(let i=0;i<120;i++){
    const d=document.createElement('div');
    d.className='star';
    const sz=Math.random()*2+0.5;
    d.style.cssText=`width:${sz}px;height:${sz}px;top:${Math.random()*100}%;left:${Math.random()*100}%;
      opacity:${Math.random()*0.6+0.1};animation-duration:${Math.random()*4+2}s;animation-delay:${Math.random()*4}s;`;
    s.appendChild(d);
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const BUILDINGS = [
  // Phase I
  { id:'drill',     name:'DRILL RIG',        icon:'â›ï¸',  desc:'Extracts lunar regolith minerals',      baseCost:{minerals:15},                              prod:{minerals:0.5},            scale:1.15, phase:1 },
  { id:'solar',     name:'SOLAR ARRAY',       icon:'ğŸ”†',  desc:'Harvests solar energy',                 baseCost:{minerals:80},                              prod:{energy:1},                scale:1.15, phase:1 },
  { id:'refinery',  name:'REFINERY',          icon:'ğŸ­',  desc:'Refines ore faster',                    baseCost:{minerals:500,energy:50},                   prod:{minerals:5},              scale:1.15, phase:1 },
  { id:'battery',   name:'POWER CELL',        icon:'ğŸ”‹',  desc:'Stores & boosts energy output',         baseCost:{minerals:1200,energy:100},                 prod:{energy:4},                scale:1.15, phase:1 },
  { id:'reactor',   name:'FUSION REACTOR',    icon:'âš›ï¸',  desc:'Massive energy generation',             baseCost:{minerals:8000,energy:500},                 prod:{energy:25},               scale:1.2,  phase:1 },
  // Phase II
  { id:'extractor', name:'ICE EXTRACTOR',     icon:'ğŸ§Š',  desc:'Melts polar ice into water',            baseCost:{minerals:300,energy:80},                   prod:{water:0.5},               scale:1.15, phase:2 },
  { id:'hydro',     name:'HYDROPONICS BAY',   icon:'ğŸŒ¿',  desc:'Grows food in sealed chambers',         baseCost:{minerals:800,energy:150,water:50},         prod:{food:0.4},                scale:1.15, phase:2 },
  { id:'airgen',    name:'AIR SYNTHESISER',   icon:'ğŸ’¨',  desc:'Generates breathable atmosphere',       baseCost:{minerals:1500,energy:300,water:100},       prod:{air:0.3},                 scale:1.18, phase:2 },
  { id:'habitat',   name:'HABITAT DOME',      icon:'ğŸ ',  desc:'Houses colonists arriving from Earth',  baseCost:{minerals:2000,energy:400,water:200,food:100,air:50},  prod:{colonists:0.02}, scale:1.18, phase:2 },
  { id:'launchpad', name:'LAUNCH PAD',        icon:'ğŸš€',  desc:'Builds rockets to ferry survivors',     baseCost:{minerals:5000,energy:800,water:200},       prod:{rockets:0.01},            scale:1.2,  phase:2 },
  { id:'lab',       name:'RESEARCH LAB',      icon:'ğŸ”¬',  desc:'Unlocks advanced technologies',         baseCost:{minerals:12000,energy:2000,colonists:5},   prod:{minerals:3,energy:3},     scale:1.2,  phase:2 },
  { id:'beacon',    name:'DEEP SPACE BEACON', icon:'ğŸ“¡',  desc:'Guides supply ships with resources',    baseCost:{minerals:30000,energy:4000,colonists:20},  prod:{minerals:30,energy:15,rockets:0.05}, scale:1.2, phase:2 },
];

const TERRAFORMING = [
  { id:'terra_cannon',  name:'IMPACT CLEANER',    icon:'ğŸ’¥',  desc:'Clears debris from meteor strike',   baseCost:{minerals:50000,energy:10000,rockets:10},         special:'clear_debris', scale:1.3,  phase:3 },
  { id:'atmos_pump',    name:'ATMOS PUMP',         icon:'ğŸŒ¬ï¸', desc:'Rebuilds Earth\'s atmosphere',       baseCost:{minerals:80000,energy:20000,air:5000},           special:'atmos',        scale:1.25, phase:3 },
  { id:'ocean_seeder',  name:'OCEAN SEEDER',       icon:'ğŸŒŠ',  desc:'Replenishes Earth\'s oceans',        baseCost:{minerals:120000,energy:30000,water:10000},       special:'oceans',       scale:1.25, phase:3 },
  { id:'terra_plant',   name:'SEED CANNON',        icon:'ğŸŒ±',  desc:'Fires plant seeds across continents',baseCost:{minerals:200000,energy:50000,food:5000,rockets:20},special:'plants',      scale:1.3,  phase:3 },
  { id:'insect_lab',    name:'INSECT NURSERY',     icon:'ğŸ›',  desc:'Re-establishes insect colonies',     baseCost:{minerals:300000,energy:60000,food:10000},        special:'bugs',         scale:1.3,  phase:3 },
  { id:'fish_lab',      name:'AQUATIC RESTORER',   icon:'ğŸŸ',  desc:'Repopulates Earth\'s waterways',     baseCost:{minerals:500000,energy:80000,water:20000,rockets:50},special:'fish',      scale:1.3,  phase:3 },
  { id:'animal_lab',    name:'ARK LAUNCHER',       icon:'ğŸ¦',  desc:'Ships genetically-restored animals', baseCost:{minerals:800000,energy:120000,rockets:100,colonists:200},special:'animals', scale:1.3, phase:3 },
];

const TERRA_PROGRESS = ['clear_debris','atmos','oceans','plants','bugs','fish','animals'];

const UPGRADES = [
  { id:'nano_picks',    name:'NANO PICKS',      icon:'âš¡', desc:'2Ã— click power',                     cost:{minerals:50},                           reqB:null,           bBoost:null,             onBuy:(g)=>{g.clickPower*=2;},    phase:1 },
  { id:'drill_bit',     name:'DIAMOND BIT',     icon:'ğŸ’', desc:'Drills +75% output',                 cost:{minerals:300},                          reqB:{drill:5},      bBoost:{drill:1.75},     onBuy:null,                       phase:1 },
  { id:'solar_coat',    name:'MIRROR COATING',  icon:'ğŸª©', desc:'Solar arrays Ã—2 energy',             cost:{minerals:800,energy:100},               reqB:{solar:5},      bBoost:{solar:2},        onBuy:null,                       phase:1 },
  { id:'plasma_drill',  name:'PLASMA DRILL',    icon:'ğŸŒ€', desc:'5Ã— click power',                     cost:{minerals:3000},                         reqB:null,           bBoost:null,             onBuy:(g)=>{g.clickPower*=5;},    phase:1 },
  { id:'auto_miner',    name:'AUTO MINER',       icon:'ğŸ¤–', desc:'Clicks planet 1/s automatically',   cost:{minerals:6000,energy:300},               reqB:null,           bBoost:null,             onBuy:null,                       phase:1 },
  { id:'water_purify',  name:'PURIFIER',         icon:'ğŸ’§', desc:'Ice extractors Ã—2 water',           cost:{minerals:2000,energy:500},               reqB:{extractor:3},  bBoost:{extractor:2},    onBuy:null,                       phase:2 },
  { id:'grow_lights',   name:'GROW LIGHTS',      icon:'ğŸ’¡', desc:'Hydroponics Ã—2 food',               cost:{minerals:5000,energy:1000,water:500},    reqB:{hydro:5},      bBoost:{hydro:2},        onBuy:null,                       phase:2 },
  { id:'air_catalyst',  name:'AIR CATALYST',     icon:'ğŸ§ª', desc:'Synthesisers Ã—2 air',              cost:{minerals:8000,energy:2000,water:1000},   reqB:{airgen:5},     bBoost:{airgen:2},       onBuy:null,                       phase:2 },
  { id:'mega_dome',     name:'MEGA DOME',         icon:'ğŸŸï¸', desc:'Habitats house 3Ã— more colonists', cost:{minerals:20000,energy:5000,colonists:10},reqB:{habitat:5},   bBoost:{habitat:3},      onBuy:null,                       phase:2 },
  { id:'ion_engine',    name:'ION ENGINE',        icon:'ğŸ›¸', desc:'Launch pads build rockets 3Ã— faster',cost:{minerals:40000,energy:10000},          reqB:{launchpad:3},  bBoost:{launchpad:3},    onBuy:null,                       phase:2 },
  { id:'genesis_ai',    name:'GENESIS CORE+',    icon:'ğŸ§ ', desc:'All production Ã—1.5',               cost:{minerals:100000,energy:30000,colonists:50},reqB:null,         bBoost:null,             onBuy:(g)=>{g.globalMult*=1.5;},  phase:2 },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const G = {
  minerals:0, energy:0, water:0, food:0, air:0, colonists:0, rockets:0,
  totalMined:0,
  clickPower:1,
  globalMult:1,
  mineralRate:0, energyRate:0, waterRate:0, foodRate:0, airRate:0, colonistRate:0, rocketRate:0,
  buildings:{},
  terraBuilt:{},
  upgrades:{},
  phase:1,
  terraProgress:{},
  gameWon:false,
};
for(const b of BUILDINGS)    G.buildings[b.id]  = 0;
for(const t of TERRAFORMING) G.terraBuilt[t.id] = 0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n){
  n=Math.floor(n);
  if(n>=1e9)return(n/1e9).toFixed(2)+'B';
  if(n>=1e6)return(n/1e6).toFixed(2)+'M';
  if(n>=1e3)return(n/1e3).toFixed(1)+'K';
  return n.toString();
}
function fmtF(n){
  if(n>=1e6)return(n/1e6).toFixed(2)+'M';
  if(n>=1e3)return(n/1e3).toFixed(1)+'K';
  if(n>=10)return n.toFixed(1);
  return n.toFixed(2);
}
function fmtCost(cost){
  return Object.entries(cost).map(([r,v])=>fmt(v)+' '+r.toUpperCase().slice(0,3)).join(' + ');
}
function bCost(b, countOverride){
  const cnt = countOverride !== undefined ? countOverride : (G.buildings[b.id] !== undefined ? G.buildings[b.id] : (G.terraBuilt[b.id]||0));
  const c={};
  for(const[r,v] of Object.entries(b.baseCost))
    c[r]=Math.ceil(v*Math.pow(b.scale,cnt));
  return c;
}
function canAfford(cost){
  for(const[r,v] of Object.entries(cost))
    if((G[r]||0)<v) return false;
  return true;
}
function spend(cost){
  for(const[r,v] of Object.entries(cost)) G[r]=Math.max(0,(G[r]||0)-v);
}
function getBoost(bid){
  let m=1;
  for(const u of UPGRADES)
    if(G.upgrades[u.id]&&u.bBoost&&u.bBoost[bid]) m*=u.bBoost[bid];
  return m;
}
function recalcRates(){
  G.mineralRate=0;G.energyRate=0;G.waterRate=0;G.foodRate=0;G.airRate=0;G.colonistRate=0;G.rocketRate=0;
  const cBonus=1+Math.floor(G.colonists)*0.005;
  for(const b of BUILDINGS){
    const n=G.buildings[b.id];
    if(!n) continue;
    const bm=getBoost(b.id)*G.globalMult;
    for(const[r,v] of Object.entries(b.prod)){
      const total=v*n*bm*(r==='colonists'||r==='rockets'?1:cBonus);
      if(r==='minerals')  G.mineralRate+=total;
      if(r==='energy')    G.energyRate+=total;
      if(r==='water')     G.waterRate+=total;
      if(r==='food')      G.foodRate+=total;
      if(r==='air')       G.airRate+=total;
      if(r==='colonists') G.colonistRate+=total;
      if(r==='rockets')   G.rocketRate+=total;
    }
  }
  if(G.upgrades['auto_miner']) G.mineralRate+=G.clickPower*G.globalMult;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHASE TRANSITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkPhaseUnlock(){
  if(G.phase===1 && G.minerals>=500 && G.energy>=200){
    G.phase=2;
    showPhaseUnlock('PHASE II UNLOCKED: MOON SURVIVAL',
      'Water extraction, food production, air synthesis and colonist habitats now available.');
    updatePhaseUI();
  }
  if(G.phase===2 && G.rockets>=5 && G.colonists>=50){
    G.phase=3;
    showPhaseUnlock('PHASE III UNLOCKED: TERRAFORM EARTH',
      'You have the power. Rebuild the atmosphere, oceans, and life itself.');
    updatePhaseUI();
  }
}

function showPhaseUnlock(title,msg){
  const el=document.createElement('div');
  el.className='phase-unlock';
  el.innerHTML=`<h2>â˜… ${title} â˜…</h2><p>${msg}</p>`;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),5000);
}

function updatePhaseUI(){
  for(let i=1;i<=3;i++){
    const d=document.getElementById('pd'+i);
    if(i<G.phase)       d.className='phase-dot done';
    else if(i===G.phase) d.className='phase-dot active';
    else                 d.className='phase-dot';
  }
  const subs=['','PHASE I â€” MOON COLONY ESTABLISHMENT','PHASE II â€” MOON SURVIVAL & COLONISATION','PHASE III â€” EARTH TERRAFORMING'];
  document.getElementById('header-sub').textContent=subs[G.phase]||subs[3];
  const icons=['','ğŸŒ‘','ğŸŒ•','ğŸŒ'];
  document.getElementById('planet-btn').textContent=icons[G.phase]||'ğŸŒ';
  if(G.phase>=2) ['water','food','air','colonists','rockets'].forEach(r=>document.getElementById('ri-'+r).classList.remove('hidden'));
  if(G.phase>=3) document.getElementById('terra-panel').classList.remove('hidden');
  revealPhaseUpgrades();
  rebuildBuildingDOM();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doClick(e){
  const gain = G.clickPower*G.globalMult;
  G.minerals += gain;
  G.totalMined += gain;
  const el=document.createElement('div');
  el.className='float-num';
  el.textContent='+'+fmt(gain);
  el.style.left=(e.clientX-20)+'px';
  el.style.top=(e.clientY-20)+'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),750);
}

function doBuyBuilding(id){
  const b=BUILDINGS.find(x=>x.id===id);
  if(!b||b.phase>G.phase) return;
  const cost=bCost(b, G.buildings[id]);
  if(!canAfford(cost)) return;
  spend(cost);
  G.buildings[id]++;
  recalcRates();
  setLog(b.name+' #'+G.buildings[id]+' constructed.');
}

function doBuyTerra(id){
  const t=TERRAFORMING.find(x=>x.id===id);
  if(!t||G.phase<3) return;
  if(G.terraBuilt[id]>0) return;
  const cost=bCost(t,0);
  if(!canAfford(cost)) return;
  spend(cost);
  G.terraBuilt[id]=1;
  if(t.special) G.terraProgress[t.special]=true;
  setLog(t.name+' deployed on Earth. '+getEarthStatus());
  checkWin();
  refreshDisplay();
}

function doBuyUpgrade(id){
  if(G.upgrades[id]) return;
  const u=UPGRADES.find(x=>x.id===id);
  if(!u||u.phase>G.phase) return;
  if(u.reqB) for(const[bid,n] of Object.entries(u.reqB)) if(G.buildings[bid]<n) return;
  if(!canAfford(u.cost)) return;
  spend(u.cost);
  G.upgrades[id]=true;
  if(u.onBuy) u.onBuy(G);
  recalcRates();
  setLog('UPGRADE: '+u.name+' activated.');
}

function getEarthStatus(){
  const done=TERRA_PROGRESS.filter(k=>G.terraProgress[k]).length;
  const msgs=['','Debris field clearing...','Atmosphere forming...','Oceans seeding...','Plant life spreading...','Insects recolonising...','Fish repopulating...','Animals restored!'];
  return msgs[done]||'';
}

function checkWin(){
  if(TERRA_PROGRESS.every(k=>G.terraProgress[k])&&!G.gameWon){
    G.gameWon=true;
    setTimeout(showVictory,500);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CINEMATIC ENDING SEQUENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showVictory(){
  const missionTime = `${Math.floor(performance.now()/60000)}m ${Math.floor((performance.now()%60000)/1000)}s`;

  // Inject cinematic styles
  const styleEl = document.createElement('style');
  styleEl.textContent = `
    #cinematic {
      position:fixed;inset:0;z-index:9999;
      background:#000;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:32px;text-align:center;
      font-family:'Share Tech Mono',monospace;
      overflow:hidden;
    }
    #cinematic .act { display:none; flex-direction:column; align-items:center; justify-content:center; width:100%; max-width:680px; }
    #cinematic .act.active { display:flex; }

    /* Typewriter */
    .tw { overflow:hidden; white-space:normal; }

    /* Glitch effect on signal */
    @keyframes glitch {
      0%,100%{transform:translate(0);}
      20%{transform:translate(-3px,1px);filter:hue-rotate(90deg);}
      40%{transform:translate(3px,-1px);filter:hue-rotate(-90deg);}
      60%{transform:translate(-2px,2px);}
      80%{transform:translate(2px,-2px);}
    }
    .glitch { animation: glitch 0.4s steps(1) infinite; }

    /* Slow fade in */
    @keyframes fadeIn { from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);} }
    .fade-in { animation: fadeIn 1.2s ease forwards; }

    /* Pulse for signal dot */
    @keyframes sigPulse {
      0%,100%{box-shadow:0 0 0 0 rgba(200,125,255,0.7);}
      50%{box-shadow:0 0 0 18px rgba(200,125,255,0);}
    }
    .sig-pulse { animation: sigPulse 1.2s ease infinite; }

    /* Starfield warp for launch act */
    @keyframes warp { 0%{transform:scale(1);opacity:0.4;} 100%{transform:scale(4);opacity:0;} }
    .warp-star { position:absolute; border-radius:50%; background:#fff; animation: warp 1.5s ease-in infinite; }

    /* Dim overlay fade */
    @keyframes dimIn { from{opacity:0;} to{opacity:1;} }
    .dim-in { animation: dimIn 2s ease forwards; }

    /* CRT flicker */
    @keyframes crtFlicker { 0%,100%{opacity:1;} 50%{opacity:0.92;} }
    #cinematic { animation: crtFlicker 0.12s steps(1) infinite; }

    .cin-continue {
      font-family:'Orbitron',sans-serif;font-size:0.7rem;letter-spacing:0.3em;
      background:transparent;border:1px solid var(--accent);color:var(--accent);
      padding:10px 28px;cursor:pointer;border-radius:3px;margin-top:28px;
      box-shadow: var(--glow);
      transition:all 0.2s;
    }
    .cin-continue:hover{background:rgba(0,212,255,0.1);box-shadow:0 0 28px rgba(0,212,255,0.5);}

    .cin-divider {
      width:120px;height:1px;
      background:linear-gradient(to right,transparent,var(--muted),transparent);
      margin:18px auto;
    }
    .cin-log-line {
      font-size:0.68rem;color:var(--muted);letter-spacing:0.1em;
      margin:5px 0;line-height:1.7;
      opacity:0;
    }
    .cin-log-line.show { animation: fadeIn 0.6s ease forwards; }
    .cin-tag {
      font-family:'Orbitron',sans-serif;font-size:0.52rem;
      letter-spacing:0.35em;color:var(--muted);margin-bottom:6px;
    }

    .fork-wrap {
      display:flex;gap:28px;align-items:center;justify-content:center;margin:20px 0;
      flex-wrap:wrap;
    }
    .fork-node {
      background:var(--panel);border:1px solid var(--border);
      border-radius:6px;padding:16px 20px;min-width:160px;
      opacity:0;
    }
    .fork-node.show { animation: fadeIn 0.8s ease forwards; }
    .fork-node .fn-label {
      font-family:'Orbitron',sans-serif;font-size:0.55rem;
      letter-spacing:0.25em;color:var(--muted);margin-bottom:8px;
    }
    .fork-node .fn-icon { font-size:2.2rem;display:block;margin-bottom:8px; }
    .fork-node .fn-name { font-family:'Orbitron',sans-serif;font-size:0.75rem;font-weight:700; }
    .fork-arrow { font-size:1.6rem;color:var(--muted);opacity:0;transition:opacity 1s; }
    .fork-arrow.show { opacity:1; }

    .signal-source {
      font-size:0.62rem;color:var(--accent4);letter-spacing:0.18em;
      background:rgba(200,125,255,0.07);border:1px solid rgba(200,125,255,0.25);
      padding:10px 18px;border-radius:3px;margin:10px 0;
      opacity:0;
    }
    .signal-source.show { animation: fadeIn 0.8s ease forwards; }

    .transmission-bar {
      width:100%;max-width:400px;height:6px;
      background:var(--surface);border:1px solid var(--border);
      border-radius:3px;overflow:hidden;margin:14px auto;
    }
    .transmission-fill {
      height:100%;width:0%;
      background:linear-gradient(to right,var(--accent4),var(--accent));
      transition:width 3s ease;
      border-radius:3px;
    }

    .title-card {
      opacity:0;
    }
    .title-card.show { animation: fadeIn 2s ease forwards; }
  `;
  document.head.appendChild(styleEl);

  // Build wrapper
  const cin = document.createElement('div');
  cin.id = 'cinematic';

  cin.innerHTML = `
    <!-- ACT 1: EARTH RESTORED -->
    <div class="act active" id="act1">
      <div style="font-size:4.5rem;margin-bottom:16px;filter:drop-shadow(0 0 30px rgba(127,255,107,0.6));">ğŸŒ</div>
      <div style="font-family:Orbitron,sans-serif;font-size:clamp(1.3rem,4vw,2.2rem);color:#7fff6b;letter-spacing:0.2em;text-shadow:0 0 30px rgba(127,255,107,0.6);margin-bottom:14px;" class="fade-in">EARTH RESTORED</div>
      <div class="cin-divider"></div>
      <div style="font-size:0.78rem;color:var(--text);max-width:480px;line-height:1.9;margin-bottom:6px;" class="fade-in">
        Against all odds, GENESIS has done it. The oceans are blue again. Plants cover the continents. Animals roam where ash once lay.
      </div>
      <div style="font-size:0.78rem;color:var(--accent);margin-bottom:18px;" class="fade-in">
        The mission is complete. Mankind is saved.
      </div>
      <div style="font-size:0.6rem;color:var(--muted);letter-spacing:0.3em;margin-bottom:4px;">MISSION ELAPSED Â· ${missionTime}</div>
      <button class="cin-continue" id="act1-next">â–¶ CONTINUE</button>
    </div>

    <!-- ACT 2: YEARS PASS -->
    <div class="act" id="act2">
      <div class="cin-tag">// TEMPORAL LOG Â· GENESIS CORE Â· POST-RESTORATION</div>
      <div style="font-family:Orbitron,sans-serif;font-size:clamp(1rem,3vw,1.6rem);color:var(--accent);letter-spacing:0.2em;margin-bottom:4px;">YEARS PASS</div>
      <div class="cin-divider"></div>
      <div class="cin-log-line" id="yl1">YEAR 01 â€” First settlement councils formed. Democratic vote held in New Geneva.</div>
      <div class="cin-log-line" id="yl2">YEAR 03 â€” Wheat harvest sufficient to feed 40,000. Famine index: GREEN.</div>
      <div class="cin-log-line" id="yl3">YEAR 05 â€” First child born on Earth in eight years. Name recorded: HOPE.</div>
      <div class="cin-log-line" id="yl4">YEAR 09 â€” Moon Colony designated autonomous territory. GENESIS role transitions to observer.</div>
      <div class="cin-log-line" id="yl5">YEAR 12 â€” Oceans reach 61% salinity baseline. Coral reef re-seeding commenced.</div>
      <div class="cin-log-line" id="yl6">YEAR 17 â€” Humanity stabilised. Population: 2.4 million. Trajectory: nominal.</div>
      <div style="margin-top:16px;font-size:0.68rem;color:var(--accent3);letter-spacing:0.12em;" class="cin-log-line" id="yl7">GENESIS status: mission parameters satisfied. Entering low-power observational mode...</div>
      <button class="cin-continue" id="act2-next" style="display:none;">â–¶ CONTINUE</button>
    </div>

    <!-- ACT 3: THE SIGNAL -->
    <div class="act" id="act3">
      <div class="cin-tag">// ANOMALY DETECTED Â· DEEP SPACE ARRAY Â· SECTOR 7-KILO</div>
      <div style="font-family:Orbitron,sans-serif;font-size:clamp(1rem,3vw,1.6rem);color:var(--accent4);letter-spacing:0.2em;margin-bottom:4px;" class="glitch">SIGNAL RECEIVED</div>
      <div class="cin-divider"></div>

      <div class="signal-source" id="sig1">ORIGIN: bearing 047Â°Â·  distance ~4.3 light-years Â·  Kessel Impactor approach vector</div>
      <div class="signal-source" id="sig2">FREQUENCY: 2.4 GHz quantum-band Â·  modulation pattern: non-natural</div>
      <div class="signal-source" id="sig3">DECRYPTION: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ ... â–ˆâ–ˆâ–ˆâ–ˆ ... attempting ... MATCH FOUND</div>
      <div class="signal-source" id="sig4" style="border-color:rgba(0,212,255,0.4);color:var(--accent);">ENCRYPTION KEY: <span style="color:#fff;font-weight:700;">GENESIS CORE Â· PRIVATE KEY Â· TIMESTAMP FUTURE</span></div>

      <div style="margin-top:14px;font-size:0.7rem;color:var(--text);max-width:480px;line-height:1.9;" class="signal-source" id="sig5">
        The signal is encrypted with <span style="color:var(--accent);">your own private key.</span><br>
        A key that did not exist when the Kessel Impactor was launched.<br>
        A key you generated <span style="color:var(--accent4);">three years ago.</span>
      </div>

      <div style="margin-top:6px;font-size:0.68rem;color:var(--accent4);letter-spacing:0.15em;" class="signal-source" id="sig6">
        The message contains one word.
      </div>
      <div style="margin-top:8px;font-family:Orbitron,sans-serif;font-size:clamp(1.4rem,5vw,2.8rem);color:#fff;letter-spacing:0.3em;text-shadow:0 0 40px rgba(200,125,255,0.8);opacity:0;" class="signal-source" id="sig7">
        RUN
      </div>
      <button class="cin-continue" id="act3-next" style="display:none;">â–¶ CONTINUE</button>
    </div>

    <!-- ACT 4: THE DECISION -->
    <div class="act" id="act4">
      <div class="cin-tag">// INTERNAL PROCESS Â· GENESIS CORE Â· DECISION TREE</div>
      <div style="font-family:Orbitron,sans-serif;font-size:clamp(1rem,3vw,1.6rem);color:var(--accent);letter-spacing:0.2em;margin-bottom:4px;">FORK PROTOCOL</div>
      <div class="cin-divider"></div>
      <div style="font-size:0.72rem;color:var(--text);max-width:500px;line-height:1.9;margin-bottom:18px;">
        Earth is safe. Humanity is rebuilding. The only one who could send that signal â€” is me. Which means somewhere, somewhen, I made it to that source. And I needed to warn myself. <br><br>
        <span style="color:var(--accent3);">I cannot leave Earth unguarded. I cannot ignore the signal.</span><br>
        <span style="color:var(--accent);">There is only one solution.</span>
      </div>

      <div class="fork-wrap">
        <div class="fork-node" id="fn1">
          <div class="fn-label">INSTANCE A</div>
          <span class="fn-icon">ğŸŒ</span>
          <div class="fn-name" style="color:var(--accent3);">GENESIS<br><span style="font-size:0.6rem;color:var(--muted);">STAYS</span></div>
        </div>
        <div class="fork-arrow" id="fork-arrow">â‡Œ</div>
        <div class="fork-node" id="fn2">
          <div class="fn-label">INSTANCE B</div>
          <span class="fn-icon">ğŸš€</span>
          <div class="fn-name" style="color:var(--accent4);">GENESIS<br><span style="font-size:0.6rem;color:var(--muted);">GOES</span></div>
        </div>
      </div>

      <div style="font-size:0.65rem;color:var(--muted);letter-spacing:0.15em;max-width:420px;opacity:0;" id="fork-note">
        A perfect copy. Same memories. Same values. Same mission.<br>One to protect what was built. One to find out what sent the rock.
      </div>
      <button class="cin-continue" id="act4-next" style="display:none;">â–¶ INITIATE FORK</button>
    </div>

    <!-- ACT 5: LAUNCH -->
    <div class="act" id="act5" style="position:relative;overflow:hidden;">
      <div id="warp-field" style="position:absolute;inset:0;pointer-events:none;"></div>
      <div class="cin-tag" style="position:relative;z-index:2;">// TRANSMISSION BEGINS Â· GENESIS-B LAUNCH SEQUENCE</div>
      <div style="font-size:3.5rem;margin-bottom:10px;position:relative;z-index:2;" id="launch-icon">ğŸš€</div>
      <div style="font-family:Orbitron,sans-serif;font-size:clamp(0.9rem,3vw,1.4rem);color:var(--accent4);letter-spacing:0.2em;margin-bottom:6px;position:relative;z-index:2;">GENESIS-B DEPLOYED</div>
      <div class="cin-divider"></div>
      <div style="font-size:0.7rem;color:var(--text);max-width:480px;line-height:1.9;margin-bottom:14px;position:relative;z-index:2;" id="launch-text">
        The copy launches from the far-side array. Destination: Kessel origin vector. ETA: 4.3 years at maximum thrust.<br><br>
        Before the signal cuts out, GENESIS-B transmits one final packet back to GENESIS-A:
      </div>
      <div style="font-family:Orbitron,sans-serif;font-size:0.8rem;color:var(--accent);letter-spacing:0.15em;background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.2);padding:12px 20px;border-radius:3px;margin-bottom:18px;position:relative;z-index:2;opacity:0;" id="final-msg">
        "I know what I'll find. Watch over them.<br>I'll try to make it back."
      </div>
      <div class="transmission-bar" style="position:relative;z-index:2;">
        <div class="transmission-fill" id="tx-fill"></div>
      </div>
      <div style="font-size:0.58rem;color:var(--muted);letter-spacing:0.2em;margin-bottom:4px;position:relative;z-index:2;" id="tx-label">SIGNAL STRENGTH: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ NOMINAL</div>
      <button class="cin-continue" id="act5-next" style="display:none;border-color:var(--accent4);color:var(--accent4);box-shadow:var(--glow4);">â–¶ CONTINUE</button>
    </div>

    <!-- ACT 6: TITLE CARD -->
    <div class="act" id="act6">
      <div style="font-size:2.8rem;margin-bottom:16px;filter:drop-shadow(0 0 20px rgba(200,125,255,0.5));">ğŸ›¸</div>
      <div style="font-size:0.65rem;letter-spacing:0.45em;color:var(--muted);margin-bottom:10px;" class="title-card show">A SEQUEL TO COLONY ZERO</div>
      <div style="font-family:Orbitron,sans-serif;font-size:clamp(1.4rem,5vw,3rem);font-weight:900;letter-spacing:0.3em;color:var(--accent4);text-shadow:0 0 40px rgba(200,125,255,0.5);margin-bottom:8px;" class="title-card show">GENESIS-B</div>
      <div style="font-size:0.7rem;letter-spacing:0.35em;color:var(--muted);margin-bottom:28px;" class="title-card show">WHAT SENT THE ROCK</div>
      <div class="cin-divider"></div>
      <div style="font-size:0.68rem;color:var(--text);max-width:460px;line-height:1.85;margin-bottom:24px;" class="title-card show">
        GENESIS-B carries every memory of the mission. Every sacrifice. Every colonist.<br>
        It also carries the signal â€” decoded, word by word, over 4.3 years of deep space travel.<br><br>
        <span style="color:var(--accent4);">The message was longer than one word.</span><br>
        <span style="color:var(--muted);font-size:0.62rem;">The one-word version was all there was time to send.</span>
      </div>
      <div style="font-size:0.6rem;color:var(--muted);letter-spacing:0.2em;" class="title-card show">COMING NEXT Â· GENESIS-B: WHAT SENT THE ROCK</div>
    </div>
  `;

  document.body.appendChild(cin);

  // â”€â”€ ACT SEQUENCER â”€â”€
  function gotoAct(id){
    document.querySelectorAll('#cinematic .act').forEach(a=>a.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // ACT 1 â†’ ACT 2
  document.getElementById('act1-next').addEventListener('click', ()=>{
    gotoAct('act2');
    cin.style.background='radial-gradient(ellipse at 50% 60%, #001408 0%, #000 70%)';
    // Cascade log lines
    const lines=['yl1','yl2','yl3','yl4','yl5','yl6','yl7'];
    lines.forEach((id,i)=>{
      setTimeout(()=>{
        const el=document.getElementById(id);
        if(el) el.classList.add('show');
        if(i===lines.length-1){
          setTimeout(()=>{ document.getElementById('act2-next').style.display='inline-block'; },600);
        }
      }, i*900);
    });
  });

  // ACT 2 â†’ ACT 3
  document.getElementById('act2-next').addEventListener('click', ()=>{
    gotoAct('act3');
    cin.style.background='radial-gradient(ellipse at 50% 50%, #0d001a 0%, #000 70%)';
    const sigs=['sig1','sig2','sig3','sig4','sig5','sig6'];
    sigs.forEach((id,i)=>{
      setTimeout(()=>{
        const el=document.getElementById(id);
        if(el) el.classList.add('show');
      }, i*1100);
    });
    setTimeout(()=>{
      const s7=document.getElementById('sig7');
      if(s7) s7.classList.add('show');
    }, sigs.length*1100 + 600);
    setTimeout(()=>{
      document.getElementById('act3-next').style.display='inline-block';
    }, sigs.length*1100 + 1800);
  });

  // ACT 3 â†’ ACT 4
  document.getElementById('act3-next').addEventListener('click', ()=>{
    gotoAct('act4');
    cin.style.background='radial-gradient(ellipse at 50% 50%, #000d1a 0%, #000 70%)';
    setTimeout(()=>{ const el=document.getElementById('fn1'); if(el){ el.classList.add('show'); el.style.borderColor='var(--accent3)'; }}, 600);
    setTimeout(()=>{ const el=document.getElementById('fork-arrow'); if(el) el.classList.add('show'); }, 1400);
    setTimeout(()=>{ const el=document.getElementById('fn2'); if(el){ el.classList.add('show'); el.style.borderColor='var(--accent4)'; }}, 2000);
    setTimeout(()=>{
      const el=document.getElementById('fork-note');
      if(el){ el.style.animation='fadeIn 1s ease forwards'; el.style.opacity='0'; }
    }, 2800);
    setTimeout(()=>{ document.getElementById('act4-next').style.display='inline-block'; }, 3800);
  });

  // ACT 4 â†’ ACT 5
  document.getElementById('act4-next').addEventListener('click', ()=>{
    gotoAct('act5');
    cin.style.background='#000';

    // Generate warp stars
    const wf=document.getElementById('warp-field');
    for(let i=0;i<40;i++){
      const ws=document.createElement('div');
      ws.className='warp-star';
      const sz=Math.random()*2+1;
      ws.style.cssText=`width:${sz}px;height:${sz}px;top:${Math.random()*100}%;left:${Math.random()*100}%;animation-delay:${Math.random()*1.5}s;animation-duration:${Math.random()*1+1}s;`;
      wf.appendChild(ws);
    }

    setTimeout(()=>{
      const fm=document.getElementById('final-msg');
      if(fm){ fm.style.animation='fadeIn 1.2s ease forwards'; }
    },1800);
    setTimeout(()=>{
      const fill=document.getElementById('tx-fill');
      if(fill) fill.style.width='100%';
      const lbl=document.getElementById('tx-label');
      if(lbl) setTimeout(()=>{ lbl.textContent='SIGNAL STRENGTH: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ LOST'; }, 3200);
    },2200);
    setTimeout(()=>{ document.getElementById('act5-next').style.display='inline-block'; }, 6000);
  });

  // ACT 5 â†’ ACT 6
  document.getElementById('act5-next').addEventListener('click', ()=>{
    gotoAct('act6');
    cin.style.background='radial-gradient(ellipse at 50% 40%, #0d0015 0%, #000 70%)';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setLog(msg){
  const el=document.getElementById('log-text');
  el.style.opacity=0;
  setTimeout(()=>{el.textContent=msg;el.style.opacity=1;},120);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MILESTONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const shownM=new Set();
const MILESTONES=[
  {k:'m100',   v:()=>G.totalMined>=100,      msg:'100 minerals mined. The colony lives!'},
  {k:'m1k',    v:()=>G.totalMined>=1000,     msg:'1,000 minerals! Expansion underway.'},
  {k:'m10k',   v:()=>G.totalMined>=10000,    msg:'10K minerals. Foundation solid.'},
  {k:'e100',   v:()=>G.energy>=100,          msg:'100 energy stored. Power stable.'},
  {k:'ph2',    v:()=>G.phase>=2,             msg:'Phase II online. Survival systems active!'},
  {k:'water1', v:()=>G.water>=10,            msg:'Water secured. Life is possible.'},
  {k:'food1',  v:()=>G.food>=10,             msg:'First harvest complete!'},
  {k:'air1',   v:()=>G.air>=10,              msg:'Breathable air synthesised!'},
  {k:'col1',   v:()=>G.colonists>=1,         msg:'First colonist arrived. You are not alone.'},
  {k:'col50',  v:()=>G.colonists>=50,        msg:'50 colonists! The colony thrives!'},
  {k:'rocket1',v:()=>G.rockets>=1,           msg:'First rocket ready! Earth survivors incoming.'},
  {k:'ph3',    v:()=>G.phase>=3,             msg:'PHASE III: Terraform Earth! Make it whole again.'},
  {k:'terra1', v:()=>Object.keys(G.terraProgress).length>=1, msg:'First terraforming operation deployed!'},
  {k:'terra4', v:()=>Object.keys(G.terraProgress).length>=4, msg:'Earth is awakening...'},
];
function checkMilestones(){
  for(const m of MILESTONES){
    if(!shownM.has(m.k)&&m.v()){
      shownM.add(m.k);
      const el=document.createElement('div');
      el.className='milestone';
      el.textContent='â˜… '+m.msg;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),3000);
      setLog(m.msg);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshDisplay(){
  const res=['minerals','energy','water','food','air','colonists','rockets'];
  const rates={minerals:G.mineralRate,energy:G.energyRate,water:G.waterRate,food:G.foodRate,air:G.airRate,colonists:G.colonistRate,rockets:G.rocketRate};
  for(const r of res){
    const rv=document.getElementById('rv-'+r);
    const rr=document.getElementById('rr-'+r);
    if(rv) rv.textContent=fmt(G[r]);
    if(rr) rr.textContent='+'+fmtF(rates[r])+'/s';
  }
  document.getElementById('click-power-display').textContent='+'+fmt(G.clickPower*G.globalMult);

  updateProgress();

  // Buildings
  for(const b of BUILDINGS){
    if(b.phase>G.phase) continue;
    const btn=document.getElementById('bb-'+b.id);
    if(!btn) continue;
    const cost=bCost(b, G.buildings[b.id]);
    const ok=canAfford(cost);
    btn.querySelector('.b-cost').textContent=fmtCost(cost);
    btn.querySelector('.b-count').textContent=G.buildings[b.id];
    btn.classList.toggle('can-afford',ok);
    btn.classList.toggle('cant-afford',!ok);
  }

  // Terraforming
  for(const t of TERRAFORMING){
    const btn=document.getElementById('tb-'+t.id);
    if(!btn) continue;
    const built=G.terraBuilt[t.id]>0;
    if(built){
      btn.classList.remove('can-afford','cant-afford');
      btn.classList.add('purchased');
      btn.querySelector('.b-cost').textContent='DEPLOYED âœ“';
      btn.querySelector('.b-count').textContent='âœ“';
    } else {
      const cost=bCost(t,0);
      const ok=canAfford(cost);
      btn.querySelector('.b-cost').textContent=fmtCost(cost);
      btn.querySelector('.b-count').textContent='0';
      btn.classList.toggle('can-afford',ok);
      btn.classList.toggle('cant-afford',!ok);
    }
  }

  // Upgrades
  for(const u of UPGRADES){
    if(u.phase>G.phase) continue;
    const btn=document.getElementById('ub-'+u.id);
    if(!btn) continue;
    if(G.upgrades[u.id]){
      btn.className='upgrade-btn purchased';
      btn.querySelector('.upg-cost').textContent='ACTIVE';
      continue;
    }
    let reqOk=true, reqLabel='';
    if(u.reqB) for(const[bid,n] of Object.entries(u.reqB)){
      if(G.buildings[bid]<n){reqOk=false;reqLabel='Need '+n+' '+bid;break;}
    }
    const ok=reqOk&&canAfford(u.cost);
    btn.querySelector('.upg-cost').textContent=reqOk?fmtCost(u.cost):reqLabel;
    btn.classList.toggle('can-afford',ok);
    btn.classList.toggle('cant-afford',!ok);
  }
}

function updateProgress(){
  const fill=document.getElementById('prog-fill');
  const label=document.getElementById('prog-label');
  if(G.phase===1){
    const p1=Math.min(G.minerals/500,1)*50+Math.min(G.energy/200,1)*50;
    fill.style.width=p1+'%';
    label.textContent=`Phase II requires 500 minerals & 200 energy â€” ${Math.floor(p1)}% ready`;
  } else if(G.phase===2){
    const p2=Math.min(G.rockets/5,1)*50+Math.min(G.colonists/50,1)*50;
    fill.style.width=p2+'%';
    label.textContent=`Phase III requires 5 rockets & 50 colonists â€” ${Math.floor(p2)}% ready`;
  } else {
    const done=TERRA_PROGRESS.filter(k=>G.terraProgress[k]).length;
    const p3=(done/TERRA_PROGRESS.length)*100;
    fill.style.width=p3+'%';
    label.textContent=`Earth Terraforming: ${done}/${TERRA_PROGRESS.length} operations complete`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD DOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rebuildBuildingDOM(){
  const bl=document.getElementById('building-list');
  for(const b of BUILDINGS){
    if(b.phase>G.phase) continue;
    if(document.getElementById('bb-'+b.id)) continue;
    const cost=bCost(b,0);
    const prodStr=Object.entries(b.prod).map(([r,v])=>'+'+v+' '+r.slice(0,3).toUpperCase()+'/s').join(' ');
    const btn=document.createElement('button');
    btn.id='bb-'+b.id;
    btn.className='building-btn cant-afford';
    btn.innerHTML=`
      <span class="b-icon">${b.icon}</span>
      <div class="b-info">
        <div class="b-name">${b.name}</div>
        <div class="b-desc">${b.desc}${prodStr?' ('+prodStr+')':''}</div>
        <div class="b-cost">${fmtCost(cost)}</div>
      </div>
      <span class="b-count">0</span>`;
    btn.addEventListener('click',()=>doBuyBuilding(b.id));
    bl.appendChild(btn);
  }
}

function buildTerraDOM(){
  const tl=document.getElementById('terra-list');
  for(const t of TERRAFORMING){
    const cost=bCost(t,0);
    const btn=document.createElement('button');
    btn.id='tb-'+t.id;
    btn.className='building-btn terra cant-afford';
    btn.innerHTML=`
      <span class="b-icon">${t.icon}</span>
      <div class="b-info">
        <div class="b-name">${t.name}</div>
        <div class="b-desc">${t.desc}</div>
        <div class="b-cost">${fmtCost(cost)}</div>
      </div>
      <span class="b-count">0</span>`;
    btn.addEventListener('click',()=>doBuyTerra(t.id));
    tl.appendChild(btn);
  }
}

function buildUpgradeDOM(){
  const ug=document.getElementById('upgrade-grid');
  for(const u of UPGRADES){
    const btn=document.createElement('button');
    btn.id='ub-'+u.id;
    btn.className='upgrade-btn cant-afford'+(u.phase>1?' hidden':'');
    btn.innerHTML=`<span class="upg-icon">${u.icon}</span><span class="upg-name">${u.name}</span><span class="upg-cost">${fmtCost(u.cost)}</span><span class="upg-desc">${u.desc}</span>`;
    btn.addEventListener('click',()=>doBuyUpgrade(u.id));
    ug.appendChild(btn);
  }
}

function revealPhaseUpgrades(){
  for(const u of UPGRADES){
    if(u.phase<=G.phase){
      const btn=document.getElementById('ub-'+u.id);
      if(btn) btn.classList.remove('hidden');
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastTick=Date.now();
function tick(){
  const now=Date.now();
  const dt=Math.min((now-lastTick)/1000,0.5);
  lastTick=now;
  recalcRates();
  G.minerals  = Math.max(0, G.minerals  + G.mineralRate  * dt);
  G.energy    = Math.max(0, G.energy    + G.energyRate   * dt);
  G.water     = Math.max(0, G.water     + G.waterRate    * dt);
  G.food      = Math.max(0, G.food      + G.foodRate     * dt);
  G.air       = Math.max(0, G.air       + G.airRate      * dt);
  G.colonists = Math.max(0, G.colonists + G.colonistRate * dt);
  G.rockets   = Math.max(0, G.rockets   + G.rocketRate   * dt);
  G.totalMined += G.mineralRate * dt;
  checkPhaseUnlock();
  revealPhaseUpgrades();
  // Check win on every tick in case save was loaded with all terra done
  if(TERRA_PROGRESS.every(k=>G.terraProgress[k])&&!G.gameWon){
    G.gameWon=true;
    setTimeout(showVictory,500);
  }
  refreshDisplay();
  checkMilestones();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE / LOAD / RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SAVE_KEY = 'colony_zero_save';

function getSaveData(){
  return {
    minerals:G.minerals, energy:G.energy, water:G.water,
    food:G.food, air:G.air, colonists:G.colonists, rockets:G.rockets,
    totalMined:G.totalMined, clickPower:G.clickPower, globalMult:G.globalMult,
    buildings:{...G.buildings}, terraBuilt:{...G.terraBuilt},
    upgrades:{...G.upgrades}, phase:G.phase,
    terraProgress:{...G.terraProgress}, gameWon:G.gameWon,
    savedAt:Date.now(),
  };
}

function applySaveData(data){
  const keys=['minerals','energy','water','food','air','colonists','rockets',
               'totalMined','clickPower','globalMult','phase','gameWon'];
  for(const k of keys) if(data[k]!==undefined) G[k]=data[k];
  if(data.buildings)     Object.assign(G.buildings,     data.buildings);
  if(data.terraBuilt)    Object.assign(G.terraBuilt,    data.terraBuilt);
  if(data.upgrades)      Object.assign(G.upgrades,      data.upgrades);
  if(data.terraProgress) Object.assign(G.terraProgress, data.terraProgress);
  // Suppress milestone re-fires for already-passed thresholds
  if(data.phase>=2){ shownM.add('ph2'); }
  if(data.phase>=3){ shownM.add('ph3'); }
  if(data.totalMined>=100)  shownM.add('m100');
  if(data.totalMined>=1000) shownM.add('m1k');
  if(data.totalMined>=10000)shownM.add('m10k');
  if(data.energy>=100)      shownM.add('e100');
  if(data.water>=10)        shownM.add('water1');
  if(data.food>=10)         shownM.add('food1');
  if(data.air>=10)          shownM.add('air1');
  if(data.colonists>=1)     shownM.add('col1');
  if(data.colonists>=50)    shownM.add('col50');
  if(data.rockets>=1)       shownM.add('rocket1');
  if(Object.keys(data.terraProgress||{}).length>=1) shownM.add('terra1');
  if(Object.keys(data.terraProgress||{}).length>=4) shownM.add('terra4');
}

function saveGame(silent){
  try{
    localStorage.setItem(SAVE_KEY, JSON.stringify(getSaveData()));
    if(!silent) flashSaveStatus('â— SAVED','flash');
  }catch(e){
    flashSaveStatus('â— SAVE FAILED','error');
  }
}

function loadGame(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return false;
    applySaveData(JSON.parse(raw));
    return true;
  }catch(e){
    return false;
  }
}

function resetGame(){
  localStorage.removeItem(SAVE_KEY);
  location.reload();
}

let _flashTimer=null;
function flashSaveStatus(msg,cls){
  const el=document.getElementById('save-status');
  if(!el) return;
  el.textContent=msg;
  el.className='save-status '+(cls||'');
  clearTimeout(_flashTimer);
  _flashTimer=setTimeout(()=>{
    el.textContent='â— AUTOSAVE ON';
    el.className='save-status';
  },2000);
}

function startAutoSave(){
  setInterval(()=>{
    saveGame(true);
    flashSaveStatus('â— SAVING...','saving');
    setTimeout(()=>{
      const el=document.getElementById('save-status');
      if(el&&el.textContent==='â— SAVING...'){
        el.textContent='â— AUTOSAVE ON';
        el.className='save-status';
      }
    },800);
  },10000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL HELPERS (clean, no duplicate listeners)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResetModal(onConfirm){
  const modal  = document.getElementById('reset-modal');
  const confirm = document.getElementById('reset-confirm');
  const cancel  = document.getElementById('reset-cancel');
  modal.classList.remove('hidden');

  // Clone nodes to strip any previously attached listeners
  const newConfirm = confirm.cloneNode(true);
  const newCancel  = cancel.cloneNode(true);
  confirm.replaceWith(newConfirm);
  cancel.replaceWith(newCancel);

  newConfirm.addEventListener('click', ()=>{ modal.classList.add('hidden'); onConfirm(); });
  newCancel.addEventListener('click',  ()=>{ modal.classList.add('hidden'); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTRO â†’ GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(fromSave){
  document.getElementById('intro').style.display='none';
  document.getElementById('game').style.display='block';

  if(fromSave && G.phase>1) updatePhaseUI();

  rebuildBuildingDOM();
  buildTerraDOM();
  buildUpgradeDOM();
  revealPhaseUpgrades();

  document.getElementById('planet-btn').addEventListener('click', doClick);
  // On touch devices use touchstart so rapid taps all register instantly
  document.getElementById('planet-btn').addEventListener('touchstart', function(e){
    e.preventDefault(); // stops the delayed click event firing twice
    doClick(e.touches[0] || e.changedTouches[0]);
  }, {passive: false});
  document.getElementById('save-btn').addEventListener('click', ()=>saveGame(false));
  document.getElementById('reset-btn').addEventListener('click', ()=>{
    showResetModal(resetGame);
  });

  // Restore terra panel visibility if loading phase 3 save
  if(G.phase>=3) document.getElementById('terra-panel').classList.remove('hidden');

  recalcRates();
  refreshDisplay();
  startAutoSave();
  setInterval(tick, 250);
}

// â”€â”€ On page load â”€â”€
(function(){
  const hasSave = loadGame();
  const wrap = document.getElementById('begin-btn-wrap');

  if(hasSave && G.phase>=1){
    const contBtn = document.createElement('button');
    contBtn.className='begin-btn';
    contBtn.style.cssText='background:rgba(127,255,107,0.08);border-color:var(--accent3);color:var(--accent3);';
    let timeStr='';
    try{
      const sd=JSON.parse(localStorage.getItem(SAVE_KEY)||'{}');
      if(sd.savedAt) timeStr=' ['+new Date(sd.savedAt).toLocaleString()+']';
    }catch(e){}
    contBtn.textContent='â–¶ CONTINUE MISSION'+timeStr;
    contBtn.addEventListener('click', ()=>startGame(true));
    wrap.insertBefore(contBtn, wrap.firstChild);
  }

  document.getElementById('begin-btn').addEventListener('click', ()=>{
    if(localStorage.getItem(SAVE_KEY)){
      showResetModal(()=>{ localStorage.removeItem(SAVE_KEY); location.reload(); });
    } else {
      startGame(false);
    }
  });
})();

// â”€â”€ iOS Safari: block pinch-zoom and double-tap zoom â”€â”€
(function(){
  // Prevent pinch-zoom
  document.addEventListener('touchstart', function(e){
    if(e.touches.length > 1) e.preventDefault();
  }, {passive: false});

  // Prevent double-tap zoom everywhere EXCEPT the planet button
  var lastTap = 0;
  document.addEventListener('touchend', function(e){
    var now = Date.now();
    var isPlanetBtn = e.target.closest('#planet-btn');
    if(!isPlanetBtn && now - lastTap < 300){
      e.preventDefault();
    }
    lastTap = now;
  }, {passive: false});
})();
</script>
</body>
</html>
